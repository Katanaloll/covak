local HttpService = game:GetService("HttpService")
local StarterGui = game:GetService("StarterGui")
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:FindFirstChildOfClass("Humanoid")

-- Key Validation System
local function validateKey()
    local url = "https://querybin.neocities.org/fancelestial_uuleaks/data/userIDs.txt"
    local success, response = pcall(function()
        return game:HttpGet(url)
    end)

    if success and response then
        local validKeys = string.split(response, "\n")
        for _, key in ipairs(validKeys) do
            if getgenv().covakSettings.Main.Key == key then
                StarterGui:SetCore("SendNotification", {
                    Title = "Covax Key System",
                    Text = "Key is valid!",
                    Duration = 3
                })
                return true
            end
        end
    end

    StarterGui:SetCore("SendNotification", {
        Title = "Covax Key System",
        Text = "Key is not valid!",
        Duration = 3
    })
    
    return false
end

if not validateKey() then
    warn("⚠️ Invalid Key! Please enter a valid key in the settings table.")
    return
end

StarterGui:SetCore("SendNotification", {
    Title = "Covak Script",
    Text = "Config Updated! Key Verified.",
    Duration = 3
})

-- Toggle System for Movement Enhancements
local movementEnabled = false -- Default: OFF

local function applyMovementEnhancements()
    local RootPart = Character:FindFirstChild("HumanoidRootPart")
    if RootPart and movementEnabled then
        -- Speed Boost using BodyVelocity
        local velocity = Instance.new("BodyVelocity")
        velocity.MaxForce = Vector3.new(9e9, 0, 9e9)
        velocity.Velocity = RootPart.CFrame.LookVector * getgenv().covakSettings.Movement.Speed
        velocity.Parent = RootPart

        -- Gravity Manipulation for Jump Boost
        game.Workspace.Gravity = 196 - getgenv().covakSettings.Movement.JumpBoost

        -- Cleanup after movement effect
        wait(0.5)
        velocity:Destroy()
    end
end

-- Keybinds for Movement Enhancements
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if input.KeyCode == Enum.KeyCode.Q then
        movementEnabled = not movementEnabled

        -- Show toggle notification
        StarterGui:SetCore("SendNotification", {
            Title = "Covak Movement",
            Text = movementEnabled and "Speed & Jump Boost ENABLED!" or "Speed & Jump Boost DISABLED!",
            Duration = 3
        })
    end

    -- Apply movement only when enabled
    if movementEnabled then
        if input.KeyCode == Enum.KeyCode.Space and Character:FindFirstChildOfClass("Humanoid"):GetState() == Enum.HumanoidStateType.Jumping then
            applyMovementEnhancements()
        elseif input.KeyCode == Enum.KeyCode.LeftShift then
            applyMovementEnhancements()
        end
    end
end)

-- Apply settings dynamically when character respawns
LocalPlayer.CharacterAdded:Connect(function(newCharacter)
    Character = newCharacter
    applyMovementEnhancements()
end)
